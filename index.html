<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AN Magic Barber Shop - Reserva Online</title>

    <!-- Flatpickr CSS (calendario estilizado) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #d32f2f, #000000); /* Rojo m√°s vivo y profesional */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-attachment: fixed;
        }
        .container {
            max-width: 600px;
            width: 90%;
            margin: 20px auto;
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.85);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        h1 {
            text-align: center;
            font-size: 2.3em;
            margin-bottom: 5px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        p {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.1em;
            color: #eee;
        }
        label {
            display: block;
            margin-top: 18px;
            font-weight: bold;
            font-size: 1.05em;
        }
        input, select, textarea {
            width: 100%;
            padding: 14px;
            margin-top: 6px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px #ff3333;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            width: 100%;
            padding: 16px;
            margin-top: 28px;
            background: linear-gradient(to right, #ff0000, #cc0000);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 19px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }
        button:hover {
            background: linear-gradient(to right, #e60000, #b30000);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 0, 0, 0.4);
        }
        .flatpickr-calendar {
            background: #ffffff !important;
            border-radius: 10px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4) !important;
            color: #333 !important;
        }
        .flatpickr-day {
            border-radius: 50% !important;
            color: #333 !important;
        }
        .flatpickr-day:hover:not(.disabled) {
            background: #ff3333 !important;
            color: white !important;
        }
        .flatpickr-day.selected {
            background: #ff0000 !important;
            border-color: #ff0000 !important;
            color: white !important;
        }
        .flatpickr-day.disabled {
            color: #ccc !important;
            cursor: not-allowed !important;
        }
        .flatpickr-month {
            color: #333 !important;
        }
        .flatpickr-weekdays {
            background: #f5f5f5 !important;
        }
        .flatpickr-weekday {
            color: #333 !important;
        }
        .flatpickr-current-month {
            color: #333 !important;
        }
        .calendar-info {
            font-size: 0.85em;
            color: #aaa;
            text-align: center;
            margin-top: 4px;
        }
        .alert {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.95em;
        }
        .alert-success {
            background-color: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.5);
            color: #90ee90;
        }
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #ff6b6b;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AN Magic Barber Shop</h1>
        <p>Barbero en Parla ¬∑ Calle Juan de Austria, 6, 28982, Parla (Madrid)</p>

        <form id="reservationForm">
            <label for="name">Nombre Completo:</label>
            <input type="text" id="name" name="name" required placeholder="Ej: Mar√≠a L√≥pez">

            <label for="email">Correo Electr√≥nico:</label>
            <input type="email" id="email" name="email" required placeholder="tu@email.com">

            <label for="phone">Tel√©fono:</label>
            <input type="tel" id="phone" name="phone" required placeholder="+34 600 000 000">

            <label for="servicio">Servicio:</label>
            <select id="servicio" name="servicio" required>
                <option value="">Selecciona un servicio</option>
                <option value="Corte">Corte</option>
                <option value="Barba">Barba</option>
                <option value="Corte y Barba">Corte y Barba</option>
            </select>

            <label for="peluquero">Peluquero:</label>
            <select id="peluquero" name="peluquero" required>
                <option value="">Selecciona un peluquero</option>
                <option value="Ayoub">Ayoub</option>
                <option value="Nabil">Nabil</option>
            </select>

            <label for="date">Fecha de la cita:</label>
            <input type="text" id="date" name="date" required placeholder="Selecciona una fecha">
            <div class="calendar-info">‚úÖ Horarios:<br>Lunes a S√°bado: 9:30 - 20:00<br>Martes: 15:30 - 21:00<br>Domingo: 10:00 - 14:00</div>

            <label for="time">Hora:</label>
            <input type="time" id="time" name="time" required min="09:30" max="19:45" step="900">
            <div id="horasInfo" style="font-size: 0.85em; color: #aaa; margin-top: 4px;"></div>

            <label for="comentarios">Comentarios (opcional):</label>
            <textarea id="comentarios" name="comentarios" rows="4" placeholder="Escribe aqu√≠ cualquier comentario o solicitud especial..."></textarea>

            <button type="submit" id="submitBtn">
                <span id="btnText">‚úÇÔ∏è Reservar Cita</span>
                <span id="btnSpinner" class="spinner" style="display: none;"></span>
    </button>
            
            <div id="mensajeAlerta"></div>
      </form>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        // Configuraci√≥n del webhook de n8n
        // IMPORTANTE: Cambia esta URL por la URL real de tu webhook de n8n
        const WEBHOOK_URL = 'http://localhost:5678/webhook-test/reserva-peluqueria';
        
        // URL para consultar horas reservadas (debe ser un endpoint GET en n8n)
        // Si no tienes un endpoint separado, puedes usar el mismo webhook con m√©todo GET
        const WEBHOOK_CONSULTA_URL = 'http://localhost:5678/webhook/consultar-reservas';
        
        // Modo debug (muestra informaci√≥n en consola)
        const DEBUG_MODE = true;
        
        // Variable para almacenar horas reservadas (formato: { fecha: { hora: [peluqueros] } })
        let horasReservadas = {};
        
        // Funci√≥n para consultar horas reservadas desde n8n
        // NOTA: Necesitas crear un webhook en n8n que reciba la fecha y peluquero como par√°metros GET
        // y devuelva un array de horas reservadas en formato ["10:00", "11:30", "15:00"]
        // Ejemplo de respuesta esperada: ["10:00", "11:30"] o { "horas": ["10:00", "11:30"] }
        async function consultarHorasReservadas(fecha, peluquero = null) {
            // Si no hay URL de consulta configurada, no validar horas reservadas
            if (!WEBHOOK_CONSULTA_URL || WEBHOOK_CONSULTA_URL === '') {
                horasReservadas = [];
                return;
            }
            
            try {
                // Convertir fecha de formato d/m/Y a formato para consulta (YYYY-MM-DD)
                const partesFecha = fecha.split('/');
                const fechaConsulta = `${partesFecha[2]}-${partesFecha[1]}-${partesFecha[0]}`;
                
                // Construir URL con fecha y peluquero si est√° disponible
                let urlConsulta = `${WEBHOOK_CONSULTA_URL}?fecha=${fechaConsulta}`;
                if (peluquero) {
                    urlConsulta += `&peluquero=${encodeURIComponent(peluquero)}`;
                }
                
                // Consultar horas reservadas (ajusta la URL seg√∫n tu configuraci√≥n de n8n)
                const response = await fetch(urlConsulta, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let horasArray = [];
                    
                    // Esperamos que n8n devuelva un array de horas reservadas: ["10:00", "11:30", ...]
                    // O un objeto con la propiedad horas: { horas: ["10:00", "11:30"] }
                    if (Array.isArray(data)) {
                        horasArray = data;
                    } else if (data.horas && Array.isArray(data.horas)) {
                        horasArray = data.horas;
                    } else if (data.reservas && Array.isArray(data.reservas)) {
                        // Tambi√©n aceptar formato: { reservas: [{time: "10:00", peluquero: "Ayoub"}, ...] }
                        horasArray = data.reservas.map(r => {
                            if (typeof r === 'string') return r;
                            return r.time || r.hora || r;
                        }).filter(Boolean);
                    }
                    
                    // Almacenar por fecha y peluquero
                    const clave = peluquero ? `${fecha}_${peluquero}` : fecha;
                    horasReservadas[clave] = horasArray;
                } else {
                    const clave = peluquero ? `${fecha}_${peluquero}` : fecha;
                    horasReservadas[clave] = [];
                }
            } catch (error) {
                // Si hay error al consultar, no bloquear el formulario pero mostrar advertencia
                if (DEBUG_MODE) {
                    console.warn('No se pudieron consultar las horas reservadas. El formulario funcionar√° sin validaci√≥n de disponibilidad:', error);
                }
                const clave = peluquero ? `${fecha}_${peluquero}` : fecha;
                horasReservadas[clave] = [];
            }
        }
        
        // Funci√≥n para validar si una hora est√° reservada para un peluquero espec√≠fico
        function horaEstaReservada(hora, fecha, peluquero) {
            // Si hay peluquero, buscar espec√≠ficamente para ese peluquero
            if (peluquero) {
                const clave = `${fecha}_${peluquero}`;
                const horas = horasReservadas[clave] || [];
                return horas.includes(hora);
            }
            // Si no hay peluquero, verificar en todas las reservas de esa fecha
            const horas = horasReservadas[fecha] || [];
            return horas.includes(hora);
        }
        
        // Funci√≥n para validar hora antes de enviar
        function validarHoraDisponible(hora, fecha) {
            if (horaEstaReservada(hora)) {
                return false;
            }
            return true;
        }
        
        // Configurar flatpickr (todos los d√≠as disponibles)
        const datePicker = flatpickr("#date", {
            locale: "es",
            dateFormat: "d/m/Y",
            minDate: "today",
            onChange: async function(selectedDates, dateStr, instance) {
                // Ajustar l√≠mites de hora seg√∫n el d√≠a seleccionado
                const timeInput = document.getElementById('time');
                const horasInfo = document.getElementById('horasInfo');
                
                if (selectedDates.length > 0) {
                    const fechaSeleccionada = selectedDates[0];
                    const diaSemana = fechaSeleccionada.getDay(); // 0=Domingo, 1=Lunes, 2=Martes, etc.
                    
                    // Consultar horas reservadas para esta fecha
                    horasInfo.textContent = 'Consultando disponibilidad...';
                    // Obtener el peluquero seleccionado si existe
                    const peluqueroSeleccionado = document.getElementById('peluquero')?.value || null;
                    await consultarHorasReservadas(dateStr, peluqueroSeleccionado);
                    
                    // Domingo (0): 10:00 - 14:00
                    if (diaSemana === 0) {
                        timeInput.setAttribute('min', '10:00');
                        timeInput.setAttribute('max', '14:00');
                        timeInput.setAttribute('step', '900');
                    }
                    // Martes (2): 15:30 - 21:00
                    else if (diaSemana === 2) {
                        timeInput.setAttribute('min', '15:30');
                        timeInput.setAttribute('max', '21:00');
                        timeInput.setAttribute('step', '900');
                    }
                    // Otros d√≠as: 9:30 - 20:00
                    else {
                        timeInput.setAttribute('min', '09:30');
                        timeInput.setAttribute('max', '20:00');
                        timeInput.setAttribute('step', '900');
                    }
                    
                    // Limpiar el valor de hora si est√° fuera del rango v√°lido o reservada
                    if (timeInput.value) {
                        const [hours, minutes] = timeInput.value.split(':').map(Number);
                        let fueraRango = false;
                        
                        if (diaSemana === 0) {
                            fueraRango = hours < 10 || hours > 14 || (hours === 14 && minutes > 0);
                        } else if (diaSemana === 2) {
                            fueraRango = hours < 15 || (hours === 15 && minutes < 30) || hours > 21 || (hours === 21 && minutes > 0);
                        } else {
                            fueraRango = hours < 9 || (hours === 9 && minutes < 30) || hours > 20 || (hours === 20 && minutes > 0);
                        }
                        
                        // Tambi√©n verificar si est√° reservada
                        if (!fueraRango && horaEstaReservada(timeInput.value)) {
                            fueraRango = true;
                        }
                        
                        if (fueraRango) {
                            timeInput.value = '';
                        }
                    }
                    
                    // Mostrar informaci√≥n de horas reservadas
                    const clave = peluqueroSeleccionado ? `${dateStr}_${peluqueroSeleccionado}` : dateStr;
                    const horasOcupadas = horasReservadas[clave] || [];
                    if (horasOcupadas.length > 0) {
                        horasInfo.innerHTML = `‚ö†Ô∏è Horas no disponibles: ${horasOcupadas.join(', ')}`;
                        horasInfo.style.color = '#ff6b6b';
                    } else {
                        horasInfo.textContent = '‚úÖ Todas las horas est√°n disponibles';
                        horasInfo.style.color = '#90ee90';
                    }
                } else {
                    horasInfo.textContent = '';
                }
            }
        });
        
        // Validar hora cuando el usuario la selecciona
        document.getElementById('time').addEventListener('change', function() {
            const horaSeleccionada = this.value;
            const fechaSeleccionada = document.getElementById('date').value;
            const peluqueroSeleccionado = document.getElementById('peluquero')?.value || null;
            const horasInfo = document.getElementById('horasInfo');
            
            if (horaSeleccionada && fechaSeleccionada) {
                if (horaEstaReservada(horaSeleccionada, fechaSeleccionada, peluqueroSeleccionado)) {
                    horasInfo.innerHTML = `‚ùå Esta hora ya est√° reservada${peluqueroSeleccionado ? ' para ' + peluqueroSeleccionado : ''}. Por favor, selecciona otra.`;
                    horasInfo.style.color = '#ff6b6b';
                    this.value = '';
                }
            }
        });
        
        // Tambi√©n consultar cuando cambia el peluquero
        document.getElementById('peluquero').addEventListener('change', async function() {
            const fechaSeleccionada = document.getElementById('date').value;
            const peluqueroSeleccionado = this.value;
            const horasInfo = document.getElementById('horasInfo');
            
            if (fechaSeleccionada && peluqueroSeleccionado) {
                horasInfo.textContent = 'Consultando disponibilidad...';
                await consultarHorasReservadas(fechaSeleccionada, peluqueroSeleccionado);
                
                const clave = `${fechaSeleccionada}_${peluqueroSeleccionado}`;
                const horasOcupadas = horasReservadas[clave] || [];
                if (horasOcupadas.length > 0) {
                    horasInfo.innerHTML = `‚ö†Ô∏è Horas no disponibles: ${horasOcupadas.join(', ')}`;
                    horasInfo.style.color = '#ff6b6b';
                } else {
                    horasInfo.textContent = '‚úÖ Todas las horas est√°n disponibles';
                    horasInfo.style.color = '#90ee90';
                }
                
                // Limpiar hora si est√° reservada para este peluquero
                const horaActual = document.getElementById('time').value;
                if (horaActual && horaEstaReservada(horaActual, fechaSeleccionada, peluqueroSeleccionado)) {
                    document.getElementById('time').value = '';
                    horasInfo.innerHTML = `‚ùå La hora seleccionada ya est√° reservada para ${peluqueroSeleccionado}. Por favor, selecciona otra.`;
                    horasInfo.style.color = '#ff6b6b';
                }
            }
        });

        // Funci√≥n para mostrar mensaje de √©xito
        function mostrarExito(data) {
            const mensajeAlerta = document.getElementById('mensajeAlerta');
            mensajeAlerta.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ ¬°Cita reservada exitosamente!</strong><br>
                    Hemos recibido tu solicitud para el ${data.date} a las ${data.time} - Servicio: ${data.servicio} - Peluquero: ${data.peluquero}.<br>
                    Te contactaremos pronto para confirmar tu cita.
                </div>
            `;
            mensajeAlerta.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Funci√≥n para mostrar error
        function mostrarError(mensaje) {
            const mensajeAlerta = document.getElementById('mensajeAlerta');
            mensajeAlerta.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ùå Error</strong><br>
                    ${mensaje}
  </div>
            `;
            mensajeAlerta.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Manejo del env√≠o del formulario a n8n
        document.getElementById('reservationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const dateInput = document.getElementById('date').value;
            const timeInput = document.getElementById('time').value;
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const mensajeAlerta = document.getElementById('mensajeAlerta');

            // Validaciones b√°sicas (mensaje gen√©rico si algo est√° mal)
            let formularioValido = true;

            // Validar fecha y hora
            if (!dateInput || !timeInput) {
                formularioValido = false;
            }

            // Obtener peluquero seleccionado
            const peluqueroInput = document.getElementById('peluquero').value;
            
            // Consultar horas reservadas ANTES de validar (siempre consultar para tener datos actualizados)
            if (dateInput && timeInput && peluqueroInput) {
                // Mostrar mensaje de verificaci√≥n
                const horasInfo = document.getElementById('horasInfo');
                if (horasInfo) {
                    horasInfo.textContent = 'Verificando disponibilidad...';
                    horasInfo.style.color = '#aaa';
                }
                
                // Consultar con fecha y peluquero para validaci√≥n precisa
                await consultarHorasReservadas(dateInput, peluqueroInput);
                
                // Validar que la hora NO est√© reservada para este peluquero ANTES de continuar
                if (horaEstaReservada(timeInput, dateInput, peluqueroInput)) {
                    if (horasInfo) {
                        horasInfo.innerHTML = `‚ùå Esta hora ya est√° reservada para ${peluqueroInput}. Por favor, selecciona otra hora disponible.`;
                        horasInfo.style.color = '#ff6b6b';
                    }
                    mostrarError(`Esta hora ya est√° reservada para ${peluqueroInput}. Por favor, selecciona otra hora disponible.`);
                    return;
                }
            } else if (dateInput && timeInput) {
                // Si no hay peluquero seleccionado, validar sin peluquero
                await consultarHorasReservadas(dateInput);
                if (horaEstaReservada(timeInput, dateInput, null)) {
                    mostrarError('Esta hora ya est√° reservada. Por favor, selecciona otra hora disponible.');
                    return;
                }
            }

            // Validar hora seg√∫n el d√≠a de la semana
            if (timeInput && dateInput) {
                const [hours, minutes] = timeInput.split(':').map(Number);
                
                // Convertir fecha de formato d/m/Y a Date
                const partesFecha = dateInput.split('/');
                const fechaSeleccionada = new Date(partesFecha[2], partesFecha[1] - 1, partesFecha[0]);
                const diaSemana = fechaSeleccionada.getDay(); // 0=Domingo, 1=Lunes, 2=Martes, etc.
                
                let horaValida = false;
                
                // Domingo (0): 10:00 - 14:00
                if (diaSemana === 0) {
                    if (hours === 10 || (hours > 10 && hours < 14) || (hours === 14 && minutes === 0)) {
                        horaValida = true;
                    }
                }
                // Martes (2): 15:30 - 21:00
                else if (diaSemana === 2) {
                    if ((hours === 15 && minutes >= 30) || (hours > 15 && hours < 21) || (hours === 21 && minutes === 0)) {
                        horaValida = true;
                    }
                }
                // Otros d√≠as: 9:30 - 20:00
                else {
                    if ((hours === 9 && minutes >= 30) || (hours > 9 && hours < 20) || (hours === 20 && minutes === 0)) {
                        horaValida = true;
                    }
                }
                
                if (!horaValida) {
                    formularioValido = false;
                }
            }

            // Preparar datos para enviar a n8n
            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                servicio: formData.get('servicio'),
                peluquero: formData.get('peluquero'),
                date: formData.get('date'),
                time: formData.get('time'),
                comentarios: formData.get('comentarios') || '',
                timestamp: new Date().toISOString(),
                fechaEnvio: new Date().toLocaleString('es-ES', { 
                    timeZone: 'Europe/Madrid',
                    dateStyle: 'full',
                    timeStyle: 'medium'
                })
            };

            // Validar que todos los campos requeridos est√©n presentes (mensaje gen√©rico)
            if (!data.name || !data.email || !data.phone || !data.servicio || !data.peluquero) {
                formularioValido = false;
            }

            // Si algo est√° mal, solo mostramos un mensaje gen√©rico
            if (!formularioValido) {
                mostrarError('Los datos del formulario no son correctos. Por favor, rev√≠salos.');
                return;
            }

            if (DEBUG_MODE) {
                console.log('üì§ Enviando datos a n8n:', data);
                console.log('üîó URL del webhook:', WEBHOOK_URL);
            }

            // Deshabilitar bot√≥n y mostrar spinner
            submitBtn.disabled = true;
            btnText.textContent = 'Enviando...';
            btnSpinner.style.display = 'inline-block';
            mensajeAlerta.innerHTML = '';

            try {
                // Intentar enviar los datos
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data),
                    // Agregar modo cors para evitar problemas
                    mode: 'cors'
                });

                if (DEBUG_MODE) {
                    console.log('üì• Respuesta recibida:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                }

                // Intentar leer la respuesta (puede ser JSON o texto)
                let responseData = null;
                const contentType = response.headers.get('content-type');
                
                try {
                    if (contentType && contentType.includes('application/json')) {
                        responseData = await response.json();
                    } else {
                        responseData = await response.text();
                    }
                    
                    if (DEBUG_MODE) {
                        console.log('üì¶ Datos de respuesta:', responseData);
                    }
                } catch (parseError) {
                    if (DEBUG_MODE) {
                        console.warn('‚ö†Ô∏è No se pudo parsear la respuesta:', parseError);
                    }
                }

                // n8n puede devolver 200, 201, o incluso otros c√≥digos exitosos
                // Consideramos √©xito si el status est√° entre 200-299
                if (response.status >= 200 && response.status < 300) {
                    mostrarExito(data);
                    form.reset();
                    
                    // Resetear el calendario de flatpickr
                    const flatpickrInstance = document.getElementById('date')._flatpickr;
                    if (flatpickrInstance) {
                        flatpickrInstance.clear();
                    }
                } else {
                    // Si no es un c√≥digo de √©xito, pero n8n proces√≥ la solicitud
                    // (a veces n8n devuelve 400 pero procesa el webhook)
                    // Intentamos mostrar √©xito de todas formas si hay datos
                    if (responseData && typeof responseData === 'object') {
                        mostrarExito(data);
                        form.reset();
                    } else {
                        throw new Error(`Error ${response.status}: ${response.statusText || 'Error del servidor'}`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                // Mensaje gen√©rico sin detectar tipos de error
                mostrarError('Error del sistema');
            } finally {
                // Restaurar bot√≥n
                submitBtn.disabled = false;
                btnText.textContent = '‚úÇÔ∏è Reservar Cita';
                btnSpinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
